---
- hosts: all
  become: yes
  gather_facts: false
  vars:
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
    docker_images:
      - chanduj/traveltrails_frontend:latest
      - chanduj/traveltrails_backend:latest
      - mongo:4.4.25
  tasks:
    - name: Install docker packages
      apt:
        name: "{{ item }}"
        state: present
        update_cache: yes
      with_items:
        - apt-transport-https
        - ca-certificates
        - curl
        - software-properties-common
      tags:
        - docker

    - name: Add Dockerâ€™s official GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      tags:
        - docker

    - name: Verify that we have the key with the fingerprint
      apt_key:
        id: 0EBFCD88
        state: present
      tags:
        - docker

    - name: Set up the stable repository
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable
        state: present
        update_cache: yes
      tags:
        - docker

    - name: Update apt packages
      apt:
        update_cache: yes
      tags:
        - docker

    - name: Install docker
      apt:
        name: docker-ce
        state: present
        update_cache: yes
      tags:
        - docker

    - name: Add remote "ubuntu" user to "docker" group
      user:
        name: "ubuntu"
        group: "docker"
        append: yes
      tags:
        - docker

    - name: Pull required Docker images
      command: docker pull {{ item }}
      with_items: "{{ docker_images }}"
      tags:
        - docker

    - name: Create MongoDB volume
      command: docker volume create mongo-data
      tags:
        - docker

    - name: Run MongoDB container
      command: >
        docker run -d --name mongo -v mongo-data:/data/db
        -p 27017:27017 mongo:4.4.25
      tags:
        - docker

    - name: Run backend container
      command: >
        docker run -d --name backend --link mongo:mongo
        -p 4000:4000 chanduj/traveltrails_backend:latest
      tags:
        - docker

    - name: Run frontend container
      command: >
        docker run -d --name frontend --link backend:backend
        -p 3000:3000 chanduj/traveltrails_frontend:latest
      tags:
        - docker
